<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholenkaart Vlaanderen</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        .info.legend {
            background: white;
            padding: 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 8px;
            color: #333;
            min-width: 240px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .info.legend h3 { margin: 0 0 10px; color: #2c3e50; font-size: 16px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        
        /* ZOEKBALK STIJL */
        .search-container {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .search-box {
            display: flex;
            gap: 5px;
        }
        .search-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .search-btn {
            padding: 6px 10px;
            background-color: #e74c3c; /* Rood */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .search-btn:hover { background-color: #c0392b; }

        .filter-group { margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .filter-title { font-weight: bold; font-size: 13px; text-transform: uppercase; color: #555; }
        .toggle-links { font-size: 10px; }
        .toggle-links a { color: #0078A8; text-decoration: none; cursor: pointer; }
        .toggle-links a:hover { text-decoration: underline; }
        .checkbox-label { display: flex; align-items: center; margin-bottom: 4px; font-size: 13px; cursor: pointer; }
        .checkbox-label input { margin-right: 8px; }
        .stats { font-size: 12px; color: #888; margin-top: 10px; text-align: right; font-weight: bold; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="scholen_data.js"></script>

    <script>
        // CONFIGURATIE SORTERING
        var grootordeVolgorde = ["0 - 300 lln", "300 - 600 lln", "600 - 900 lln", "900 - 1200 lln", "1200 - 1500 lln", "1500 - 2000 lln", "2000 - 3000 lln", "> 3000 lln", "Onbekend"];

        // RODE ICOON VOOR ZOEKOPDRACHTEN
        var redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        var map = L.map('map').setView([51.05, 4.4], 9);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 20
        }).addTo(map);

        var markers = L.markerClusterGroup();
        var allMarkers = [];
        var searchMarker = null; // Variabele om de rode marker bij te houden

        var types = new Set();
        var grootordes = new Set();
        var provincies = new Set(); 

        if (typeof scholenData === 'undefined') {
            alert("Fout: 'scholen_data.js' niet gevonden!");
        } else {
            scholenData.forEach(school => {
                var type = school['Type'] ? school['Type'].trim() : "Onbekend";
                var grootorde = school['# lln grootorde'] ? school['# lln grootorde'].trim() : "Onbekend";
                var provincie = school['Provincie'] ? school['Provincie'].replace("Provincie ", "").trim() : "Onbekend";
                
                if(type === "") type = "Onbekend";
                if(grootorde === "") grootorde = "Onbekend";

                types.add(type);
                grootordes.add(grootorde);
                provincies.add(provincie);

                if (school.lat && school.lon) {
                    var marker = L.marker([school.lat, school.lon]);
                    var popupContent = `
                        <div style="min-width: 200px">
                            <h3 style="margin:0 0 5px; color:#2c3e50">${school['Naam onderneming']}</h3>
                            <div style="font-size:13px; line-height:1.4">
                                <strong>Plaats:</strong> ${school['Plaats']}<br>
                                <strong>Provincie:</strong> ${provincie}<br>
                                <strong>Type:</strong> ${type}<br>
                                <strong>Grootte:</strong> ${grootorde}
                            </div>
                        </div>`;
                    marker.bindTooltip(popupContent, { direction: 'top', offset: [0, -10] });
                    marker.filterData = { type: type, grootorde: grootorde, provincie: provincie };
                    allMarkers.push(marker);
                    markers.addLayer(marker);
                }
            });
            map.addLayer(markers);
        }

        var legend = L.control({position: 'topleft'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            
            // ZOEKBALK TOEVOEGEN
            var searchHtml = `
                <h3>Zoek Omgeving</h3>
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="addressInput" class="search-input" placeholder="Bv. Grote Markt, Antwerpen" onkeypress="handleEnter(event)">
                        <button class="search-btn" onclick="searchAddress()">Zoek</button>
                    </div>
                    <div style="font-size:11px; color:#666; margin-top:4px;">Plaatst een rode pin op de kaart.</div>
                </div>
                <h3>Filter Scholen</h3>
            `;
            div.innerHTML = searchHtml;

            function createFilterGroup(title, values, category) {
                var sortedValues = Array.from(values);
                if (category === 'grootorde') {
                    sortedValues.sort(function(a, b) { return grootordeVolgorde.indexOf(a) - grootordeVolgorde.indexOf(b); });
                } else { sortedValues.sort(); }

                var html = `<div class="filter-group"><div class="filter-header"><span class="filter-title">${title}</span><div class="toggle-links"><a onclick="toggleGroup('${category}', true)">Alles</a> / <a onclick="toggleGroup('${category}', false)">Niets</a></div></div><div id="group-${category}">`;
                sortedValues.forEach(val => {
                    html += `<label class="checkbox-label"><input type="checkbox" checked value="${val}" data-category="${category}" onchange="filterMarkers()"> ${val}</label>`;
                });
                html += '</div></div>';
                return html;
            }

            div.innerHTML += createFilterGroup('Provincie', provincies, 'provincie');
            div.innerHTML += createFilterGroup('Grootorde', grootordes, 'grootorde');
            div.innerHTML += createFilterGroup('Type', types, 'type');
            div.innerHTML += '<div class="stats" id="countDisplay">Aantal scholen: ' + allMarkers.length + '</div>';
            
            L.DomEvent.disableClickPropagation(div);
            // Zorg dat typen in het zoekveld niet de kaart bestuurt (bv spatiebalk)
            L.DomEvent.disableScrollPropagation(div);
            return div;
        };
        legend.addTo(map);

        // FUNCTIE: ZOEK ADRES VIA NOMINATIM (GRATIS)
        window.searchAddress = function() {
            var query = document.getElementById('addressInput').value;
            if (!query) return;

            // We voegen 'Belgium' toe voor betere resultaten
            var url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}, Belgium`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        var lat = data[0].lat;
                        var lon = data[0].lon;
                        
                        // Verwijder vorige zoekmarker als die er is
                        if (searchMarker) {
                            map.removeLayer(searchMarker);
                        }

                        // Plaats nieuwe rode marker
                        searchMarker = L.marker([lat, lon], {icon: redIcon}).addTo(map);
                        searchMarker.bindPopup("<b>Jouw locatie:</b><br>" + query).openPopup();

                        // Zoom naar de locatie
                        map.setView([lat, lon], 13);
                    } else {
                        alert("Adres niet gevonden. Probeer de plaatsnaam erbij te zetten.");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Er ging iets mis bij het zoeken.");
                });
        }

        window.handleEnter = function(e) {
            if(e.keyCode === 13){
                searchAddress();
            }
        }

        window.toggleGroup = function(category, isChecked) {
            document.querySelectorAll(`input[data-category="${category}"]`).forEach(input => input.checked = isChecked);
            filterMarkers();
        }

        window.filterMarkers = function() {
            var checkedTypes = [], checkedGrootordes = [], checkedProvincies = [];
            document.querySelectorAll('input[data-category="type"]:checked').forEach(c => checkedTypes.push(c.value));
            document.querySelectorAll('input[data-category="grootorde"]:checked').forEach(c => checkedGrootordes.push(c.value));
            document.querySelectorAll('input[data-category="provincie"]:checked').forEach(c => checkedProvincies.push(c.value));

            markers.clearLayers();
            var count = 0;
            allMarkers.forEach(marker => {
                if (checkedTypes.includes(marker.filterData.type) && 
                    checkedGrootordes.includes(marker.filterData.grootorde) && 
                    checkedProvincies.includes(marker.filterData.provincie)) {
                    markers.addLayer(marker);
                    count++;
                }
            });
            map.addLayer(markers);
            document.getElementById('countDisplay').innerText = 'Aantal scholen: ' + count;
        }
    </script>
</body>
</html>
